rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Get user's role from custom claims (set by Cloud Function)
    function getUserRole() {
      return request.auth.token.role;
    }

    // Check if user is admin
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }

    // Check if user is super user
    function isSuper() {
      return isAuthenticated() && getUserRole() == 'super';
    }

    // Check if user is admin or super
    function isAdminOrSuper() {
      return isAdmin() || isSuper();
    }

    // Check if user owns a resource (createdBy matches auth.uid)
    function isOwner(resourceData) {
      return isAuthenticated() && resourceData.createdBy == request.auth.uid;
    }

    // Check if creating user is setting correct createdBy
    function hasValidCreatedBy() {
      return request.resource.data.createdBy == request.auth.uid;
    }

    // ============================================
    // PERMISSION MATRIX
    // ============================================
    //
    // | Collection    | Admin      | Super           | Regular    | Guest/No-Auth |
    // |---------------|------------|-----------------|------------|---------------|
    // | users         | CRUD       | Read            | Read       | None          |
    // | groups        | CRUD       | CRUD (own)      | Read       | None          |
    // | games         | CRUD       | CRUD (own)      | Read       | None          |
    // | paymentUnits  | CRUD       | Read            | Read       | None          |
    //
    // ============================================

    // --- USERS COLLECTION ---
    match /users/{userId} {
      // Read: All authenticated users can read user profiles
      allow read: if isAuthenticated();

      // Create: Only admin can create users
      // (Regular users are created through Firebase Auth + registration flow)
      allow create: if isAdmin();

      // Update: Admin can update any user
      // Users can update ONLY specific fields on their own document:
      // - lastLoginAt (for login tracking)
      // - mustChangePassword, updatedAt (for password change flow)
      // Note: We check resource.data.authUid because the document ID is not the auth UID
      allow update: if isAdmin() ||
                    (isAuthenticated() &&
                     resource.data.authUid == request.auth.uid &&
                     request.resource.data.diff(resource.data).affectedKeys()
                       .hasOnly(['lastLoginAt', 'mustChangePassword', 'updatedAt']));

      // Delete: Only admin can delete users
      allow delete: if isAdmin();
    }

    // --- GROUPS COLLECTION ---
    match /groups/{groupId} {
      // Read: All authenticated users can read groups
      allow read: if isAuthenticated();

      // Create: Admin and Super users can create groups
      // Must set themselves as the creator
      allow create: if isAdminOrSuper() && hasValidCreatedBy();

      // Update: Admin can update any group, Super can update their own groups
      allow update: if isAdmin() || (isSuper() && isOwner(resource.data));

      // Delete: Admin can delete any group, Super can delete their own groups
      allow delete: if isAdmin() || (isSuper() && isOwner(resource.data));
    }

    // --- GAMES COLLECTION ---
    match /games/{gameId} {
      // Read: All authenticated users can read games (for viewing history, statistics)
      allow read: if isAuthenticated();

      // Create: Admin and Super users can create games
      // Must set themselves as the creator
      allow create: if isAdminOrSuper() && hasValidCreatedBy();

      // Update: Admin can update any game, Super can update their own games
      // IMPORTANT: createdBy cannot be changed (prevents ownership hijacking)
      // EXCEPTION: createdBy CAN be changed for game handoff, but only by current owner or admin
      allow update: if isAdmin() ||
                    (isSuper() && isOwner(resource.data));

      // Delete: Admin can delete any game, Super can delete their own active games
      allow delete: if isAdmin() ||
                    (isSuper() && isOwner(resource.data) && resource.data.status != 'completed');
    }

    // --- PAYMENT UNITS COLLECTION ---
    match /paymentUnits/{paymentUnitId} {
      // Read: All authenticated users can read payment units
      allow read: if isAuthenticated();

      // Create: Only admin can create payment units
      allow create: if isAdmin();

      // Update: Only admin can update payment units
      allow update: if isAdmin();

      // Delete: Only admin can delete payment units
      allow delete: if isAdmin();
    }

    // ============================================
    // DEFAULT DENY ALL
    // ============================================

    // Deny access to all other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
